<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHEGO è¨‚å–®ç³»çµ± - å®Œæ•´ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .sync-status {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
        }

        .sync-status.connected {
            background: rgba(40, 167, 69, 0.3);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .required-label::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        .form-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .form-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input:invalid {
            border-color: #dc3545;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .date-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .date-option {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .date-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .date-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .product-item {
            display: grid;
            grid-template-columns: 2fr 120px auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 5px;
        }

        .quantity-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover {
            background: #5568d3;
        }

        .quantity-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .quantity-display {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            min-width: 40px;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .add-product-btn {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .add-product-btn:hover {
            background: #218838;
        }

        .discount-info {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .discount-info h4 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .discount-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ffc107;
        }

        .discount-item:last-child {
            border-bottom: none;
        }

        .split-suggestion {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .split-suggestion h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item.checked {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .payment-method {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .payment-option {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }

        .payment-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .payment-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .bank-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .bank-option {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            background: white;
        }

        .bank-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }

        .summary-total {
            border-top: 2px solid rgba(255,255,255,0.3);
            margin-top: 10px;
            padding-top: 10px;
            font-size: 24px;
            font-weight: bold;
        }

        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .orders-table th {
            background: #667eea;
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-size: 13px;
        }

        .orders-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        .edit-btn, .save-btn, .cancel-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .edit-btn {
            background: #667eea;
            color: white;
        }

        .save-btn {
            background: #28a745;
            color: white;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .edit-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #667eea;
            border-radius: 4px;
        }

        .export-btn {
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            margin-right: 10px;
        }

        .export-btn:hover {
            background: #218838;
        }

        .inventory-config {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
        }

        .inventory-item {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .inventory-item input {
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .new-order-highlight {
            animation: highlight 2s ease;
        }

        @keyframes highlight {
            0%, 100% { background: transparent; }
            50% { background: #d4edda; }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .date-selector,
            .checkbox-group,
            .payment-method,
            .bank-options {
                grid-template-columns: 1fr;
            }

            .product-item {
                grid-template-columns: 1fr;
            }

            .orders-table {
                font-size: 11px;
            }

            .orders-table th,
            .orders-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›’ CHEGO è¨‚å–®ç³»çµ±</h1>
            <p>Google Sheets å³æ™‚åŒæ­¥ç‰ˆ</p>
            <div class="sync-status connected">
                <span>âœ… å·²é€£æ¥ Google Sheets</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('order')">ğŸ“ è¨‚å–®ä¸‹å–®</button>
            <button class="tab" onclick="switchTab('admin')">ğŸ“Š å¾Œå°ç®¡ç†</button>
            <button class="tab" onclick="switchTab('inventory')">ğŸ“¦ åº«å­˜è¨­å®š</button>
        </div>

        <div class="content">
            <!-- è¨‚å–®ä¸‹å–®é é¢ -->
            <div id="order-tab" class="tab-content active">
                <form id="orderForm">
                    <!-- 1. é¸æ“‡è³¼è²·æ—¥æœŸ -->
                    <div class="form-section">
                        <h3 class="required-label">ğŸ“… é¸æ“‡è³¼è²·æ—¥æœŸ</h3>
                        <div class="date-selector">
                            <div class="date-option" onclick="selectDate('2026/02/07')">
                                <div style="font-size: 24px; font-weight: bold;">02/07</div>
                                <div style="font-size: 14px; opacity: 0.8;">æ˜ŸæœŸå…­</div>
                            </div>
                            <div class="date-option" onclick="selectDate('2026/02/08')">
                                <div style="font-size: 24px; font-weight: bold;">02/08</div>
                                <div style="font-size: 14px; opacity: 0.8;">æ˜ŸæœŸæ—¥</div>
                            </div>
                        </div>
                        <input type="hidden" id="selectedDate" name="date" required>
                        <div class="error-message" id="dateError">è«‹é¸æ“‡è³¼è²·æ—¥æœŸ</div>
                    </div>

                    <!-- 2. å•†å“é¸æ“‡ -->
                    <div class="form-section">
                        <h3>ğŸ›ï¸ é¸æ“‡å•†å“</h3>
                        <div id="productList"></div>
                        <button type="button" class="add-product-btn" onclick="addProduct()">+ æ–°å¢å•†å“</button>
                    </div>

                    <!-- 3. å„ªæƒ æç¤º -->
                    <div id="discountInfo"></div>
                    <div id="splitSuggestion"></div>

                    <!-- 4. ç¾å ´æŠ½çå„ªæƒ  -->
                    <div class="form-section">
                        <h3>ğŸ ç¾å ´æŠ½çå„ªæƒ </h3>
                        <div id="lotteryHint" style="display:none;padding:8px 12px;background:#f8d7da;color:#721c24;border-radius:6px;font-size:13px;margin-bottom:10px;"></div>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="lottery" value="æŠ˜20" onchange="updateCheckboxStyle(this)">
                                <span>æŠ˜ $20</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="lottery" value="æŠ˜30" onchange="updateCheckboxStyle(this)">
                                <span>æŠ˜ $30</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="lottery" value="æŠ˜50" onchange="updateCheckboxStyle(this)">
                                <span>æŠ˜ $50</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="lottery" value="å®˜ç¶²9æŠ˜åˆ¸" onchange="updateCheckboxStyle(this)">
                                <span>å®˜ç¶²9æŠ˜åˆ¸</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="lottery" value="æ­è£œçµ¦æŠ˜20" onchange="updateCheckboxStyle(this)">
                                <span>æ­è£œçµ¦æŠ˜ $20</span>
                            </label>
                        </div>
                    </div>

                    <!-- 5. é¡å¤–æŠ˜æ‰£ -->
                    <div class="form-section" style="border-left: 4px solid #ff6b6b;">
                        <h3 style="color: #ff6b6b;">ğŸ’° é¡å¤–æŠ˜æ‰£ï¼ˆä¿ƒéŠ·æ´»å‹•ï¼‰</h3>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; align-items: center;">
                                <label style="font-weight: bold; color: #495057;">æŠ˜æ‰£é‡‘é¡ï¼š</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px; font-weight: bold;">$</span>
                                    <input 
                                        type="number" 
                                        id="extraDiscount" 
                                        min="0" 
                                        max="10000" 
                                        step="10" 
                                        value="0"
                                        placeholder="0"
                                        onchange="calculateTotal()"
                                        style="flex: 1; padding: 12px; border: 2px solid #ff6b6b; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center;">
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404;">
                                ğŸ’¡ é©ç”¨æƒ…å¢ƒï¼š2/8 è¥ªå­ä¿ƒéŠ·ã€ç‰¹æ®ŠæŠ˜æ‰£æ´»å‹•ç­‰<br>
                                ç¯„ä¾‹ï¼šè¥ªå­ä¸‹æ®º100å…ƒ â†’ è¼¸å…¥ 100
                            </div>
                        </div>
                    </div>

                    <!-- é‡‘é¡ç¢ºèª -->
                    <div class="summary" id="orderSummary">
                        <div class="summary-row">
                            <span>å•†å“å°è¨ˆ</span>
                            <span id="subtotal">$0</span>
                        </div>
                        <div class="summary-row">
                            <span>çµ„åˆå„ªæƒ æŠ˜æ‰£</span>
                            <span id="comboDiscount">$0</span>
                        </div>
                        <div class="summary-row">
                            <span>ç¾å ´æŠ½çæŠ˜æ‰£</span>
                            <span id="lotteryDiscount">$0</span>
                        </div>
                        <div class="summary-row" id="extraDiscountRow" style="display: none;">
                            <span>é¡å¤–æŠ˜æ‰£</span>
                            <span id="extraDiscountDisplay" style="color: #ff6b6b; font-weight: bold;">$0</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span>æ‡‰ä»˜ç¸½é¡</span>
                            <span id="totalAmount">$0</span>
                        </div>
                    </div>

                    <!-- 6. æ”¯ä»˜æ–¹å¼ -->
                    <div class="form-section">
                        <h3 class="required-label">ğŸ’³ é¸æ“‡æ”¯ä»˜æ–¹å¼</h3>
                        <div class="payment-method">
                            <div class="payment-option" onclick="selectPayment('è½‰å¸³')">
                                éŠ€è¡Œè½‰å¸³
                            </div>
                            <div class="payment-option" onclick="selectPayment('iPASS MONEY')">
                                iPASS MONEY
                            </div>
                            <div class="payment-option" onclick="selectPayment('LINEPAY')">
                                LINE PAY
                            </div>
                            <div class="payment-option" onclick="selectPayment('å®˜ç¶²åˆ·å¡')">
                                å®˜ç¶²åˆ·å¡
                            </div>
                        </div>
                        <div id="bankOptions" style="display: none;">
                            <div class="bank-options" style="margin-top: 15px;">
                                <div class="bank-option" onclick="selectBank('ä¸­ä¿¡éŠ€è¡Œ')">ä¸­ä¿¡éŠ€è¡Œ</div>
                                <div class="bank-option" onclick="selectBank('æ°¸è±éŠ€è¡Œ')">æ°¸è±éŠ€è¡Œ</div>
                                <div class="bank-option" onclick="selectBank('ç‰å±±éŠ€è¡Œ')">ç‰å±±éŠ€è¡Œ</div>
                            </div>
                        </div>
                        <input type="hidden" id="paymentMethod" name="payment" required>
                        <input type="hidden" id="bankName" name="bank">
                        <div class="error-message" id="paymentError">è«‹é¸æ“‡æ”¯ä»˜æ–¹å¼</div>
                    </div>

                    <!-- 7. è³¼è²·äººè³‡è¨Š -->
                    <div class="form-section">
                        <h3>ğŸ‘¤ è³¼è²·äººè³‡è¨Š</h3>
                        <div class="form-group">
                            <label class="required-label">å§“å</label>
                            <input type="text" name="name" required placeholder="è«‹è¼¸å…¥å§“å">
                        </div>
                        <div class="form-group">
                            <label class="required-label">é›»è©±</label>
                            <input type="tel" id="phoneInput" name="phone" required placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆè‡³å°‘8ç¢¼ï¼‰" 
                                   pattern=".{8,}" title="é›»è©±è™Ÿç¢¼è‡³å°‘éœ€è¦8ç¢¼">
                            <div class="error-message" id="phoneError">é›»è©±è™Ÿç¢¼è‡³å°‘éœ€è¦8ç¢¼</div>
                        </div>
                        <div class="form-group">
                            <label class="required-label">Email</label>
                            <input type="email" id="emailInput" name="email" required placeholder="è«‹è¼¸å…¥Emailï¼ˆç”¨æ–¼æ¥æ”¶é›»å­ç™¼ç¥¨ï¼‰"
                                   pattern="[^@]+@[^@]+\.[^@]+" title="Emailæ ¼å¼ä¸æ­£ç¢º">
                            <div class="error-message" id="emailError">Emailæ ¼å¼ä¸æ­£ç¢ºï¼Œéœ€åŒ…å«@ç¬¦è™Ÿ</div>
                        </div>
                        <div class="form-group">
                            <label>è¨‚å–®å‚™è¨»</label>
                            <textarea name="note" id="orderNote" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹åœ¨æ­¤è¨»è¨˜ï¼ˆé¸å¡«ï¼‰" 
                                      style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; min-height: 80px; font-family: inherit; resize: vertical;"></textarea>
                            <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                                ğŸ’¡ ä¾‹å¦‚ï¼šé€è²¨åœ°å€ã€ç‰¹æ®ŠåŒ…è£éœ€æ±‚ã€å–è²¨æ™‚é–“ç­‰
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn">ç¢ºèªé€å‡ºè¨‚å–®</button>
                </form>
            </div>

            <!-- å¾Œå°ç®¡ç†é é¢ -->
            <div id="admin-tab" class="tab-content">
                <button class="export-btn" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡ºExcelå ±è¡¨</button>
                <button class="export-btn" onclick="window.open('https://docs.google.com/spreadsheets/d/1wIT_yIIqjzPzykS7TkeWEibiWeNCV-o9O2dg_0Kj1N4/edit', '_blank')" style="background: #667eea;">
                    ğŸ”— é–‹å•Ÿ Google Sheets
                </button>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>ç¸½è¨‚å–®æ•¸</h3>
                        <div class="value" id="totalOrders">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ç¸½ç‡Ÿæ¥­é¡</h3>
                        <div class="value" id="totalRevenue">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ä»Šæ—¥è¨‚å–®</h3>
                        <div class="value" id="todayOrders">0</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px;">ğŸ“Š å„ç”¢å“éŠ·å”®çµ±è¨ˆ</h3>
                <div style="overflow-x: auto; margin-bottom: 30px;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>å•†å“åç¨±</th>
                                <th>æ¬¾å¼</th>
                                <th>å·²å”®å‡º</th>
                                <th>å‰©é¤˜åº«å­˜</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="productStatsBody"></tbody>
                    </table>
                </div>

                <h3 style="margin-bottom: 15px;">ğŸ“‹ è¨‚å–®æ˜ç´°</h3>
                <div style="overflow-x: auto;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>è¨‚å–®ç·¨è™Ÿ</th>
                                <th>æ—¥æœŸ</th>
                                <th>å§“å</th>
                                <th>å•†å“</th>
                                <th>é‡‘é¡</th>
                                <th>æ”¯ä»˜</th>
                                <th>å‚™è¨»</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">
                                    å°šç„¡è¨‚å–®è³‡æ–™
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- åº«å­˜è¨­å®šé é¢ -->
            <div id="inventory-tab" class="tab-content">
                <!-- Google Sheets è¨­å®š -->
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                    <h3 style="color: #856404; margin-bottom: 15px;">ğŸ”— Google Sheets åŒæ­¥è¨­å®š</h3>
                    <div id="syncStatus" style="padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; font-size: 14px; font-weight: bold; background: rgba(255,193,7,0.2); color: #856404;">âš ï¸ å°šæœªè¨­å®š Google Sheets</div>
                    <p style="margin-bottom: 15px; color: #856404; line-height: 1.6;">
                        è«‹è¼¸å…¥æ‚¨çš„ Google Apps Script ç¶²å€ï¼Œè®“è¨‚å–®è‡ªå‹•åŒæ­¥åˆ° Google Sheetsã€‚
                    </p>
                    <input 
                        type="text" 
                        id="scriptUrlInput" 
                        placeholder="è²¼ä¸Š Google Apps Script ç¶²å€ï¼ˆæ ¼å¼ï¼šhttps://script.google.com/macros/s/.../execï¼‰"
                        style="width: 100%; padding: 12px; border: 2px solid #ffc107; border-radius: 8px; margin-bottom: 10px; font-size: 14px;">
                    <button onclick="saveScriptUrl()" style="width: 100%; padding: 12px; background: #ffc107; color: #856404; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 10px;">
                        ğŸ’¾ å„²å­˜ Google Sheets è¨­å®š
                    </button>
                    <button onclick="testGoogleSheets()" style="width: 100%; padding: 12px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        ğŸ§ª æ¸¬è©¦é€£ç·š
                    </button>
                    <div id="testResult" style="margin-top: 10px; padding: 10px; border-radius: 6px; display: none;"></div>
                </div>

                <h3 style="margin-bottom: 15px;">ğŸ“¦ åº«å­˜ç®¡ç†è¨­å®š</h3>
                <div class="inventory-config">
                    <p style="margin-bottom: 15px; color: #6c757d;">
                        è«‹è¨­å®šå„å•†å“çš„æœŸåˆåº«å­˜æ•¸é‡ï¼Œç³»çµ±æœƒè‡ªå‹•è¨ˆç®—å‰©é¤˜åº«å­˜ã€‚
                    </p>
                    <div id="inventoryConfigList"></div>
                    <button onclick="saveInventoryConfig()" style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 15px;">
                        ğŸ’¾ å„²å­˜åº«å­˜è¨­å®š
                    </button>
                    <button id="resetInventoryBtn" onclick="resetInventorySheets()" style="width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 14px;">
                        ğŸ”„ åˆ·æ–° Google Sheets åº«å­˜
                    </button>
                    <button id="clearAllBtn" onclick="clearAllOrders()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 14px;">
                        ğŸ—‘ï¸ æ¸…é™¤ Google Sheets æ‰€æœ‰è¨‚å–®
                    </button>
                </div>

                <h3 style="margin: 30px 0 15px;">ğŸ“Š ç•¶å‰åº«å­˜ç‹€æ…‹</h3>
                <div style="overflow-x: auto;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>å•†å“åç¨±</th>
                                <th>æœŸåˆåº«å­˜</th>
                                <th>å·²å”®å‡º</th>
                                <th>å‰©é¤˜åº«å­˜</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== å•†å“è³‡æ–™ ==========
        const products = {
            'è¿…é¦³äº”è¶¾æ©Ÿèƒ½è¥ª': { 
                price: 490, type: 'sock',
                colorImages: {
                    'M (US4-8.5)': {
                        'å¥¶èŒ¶è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/65e0f3a82d531000205ff6c7/800x.webp?source_format=png',
                        'å¢¨ç¶ è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/65e0f3a81507560b8d4e9195/800x.webp?source_format=png',
                        'æ·±è—è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/65e0f3a8327f43001d61d101/800x.webp?source_format=png'
                    },
                    'L (US9-12)': {
                        'æ²™æ¼ è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/65eb889963226d001470427d/800x.webp?source_format=png',
                        'è»ç¶ è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/65eb889963226d0017704cd4/800x.webp?source_format=png',
                        'é»‘è‰²':   'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/65eb8899f9fdfe00179f2506/800x.webp?source_format=png'
                    }
                },
                sizes: {
                    'M (US4-8.5)': ['å¥¶èŒ¶è‰²', 'å¢¨ç¶ è‰²', 'æ·±è—è‰²'],
                    'L (US9-12)': ['æ²™æ¼ è‰²', 'è»ç¶ è‰²', 'é»‘è‰²']
                }
            },
            'å±±æµ·æ¬¾èµ¤è¶³æ„Ÿæ©Ÿèƒ½é•·è¥ª': { 
                price: 490, type: 'sock',
                colorImages: {
                    'M (US4-8.5)': {
                        'ç™½è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/6840cef83166a400100832bb/800x.webp?source_format=png',
                        'æ·±è—': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/6840cc3264ea38000f4ae36b/800x.webp?source_format=png',
                        'é»‘è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/6840cc325422da000f4683f6/800x.webp?source_format=png'
                    },
                    'L (US9-12)': {
                        'ç™½è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/6840cef83166a400100832bb/800x.webp?source_format=png',
                        'æ·±è—': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/6840cc3264ea38000f4ae36b/800x.webp?source_format=png',
                        'é»‘è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/6840cc325422da000f4683f6/800x.webp?source_format=png'
                    }
                },
                sizes: {
                    'M (US4-8.5)': ['ç™½è‰²', 'æ·±è—', 'é»‘è‰²'],
                    'L (US9-12)': ['ç™½è‰²', 'æ·±è—', 'é»‘è‰²']
                }
            },
            'èµ¤è¶³æ„Ÿæ©Ÿèƒ½è¥ªçŸ­è¥ª': { 
                price: 410, type: 'sock',
                colorImages: {
                    'M (US4-8.5)': {
                        'ç™½è‰²':   'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/66e93b217cb894001365377c/800x.webp?source_format=png',
                        'çŠç‘šç²‰': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/66e93b210f9bb4000d64396b/3860x.webp?source_format=png',
                        'é…ªæ¢¨ç¶ ': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/66e93b211bb1e3001924138e/800x.webp?source_format=png',
                        'æ·±è—':   'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/66e93b21b5924b0013fc787e/800x.webp?source_format=png'
                    },
                    'L (US9-12)': {
                        'æ·±è—è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/66e9390b0ab632000dd517cf/3860x.webp?source_format=png',
                        'é»‘è‰²':   'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/66e9390a3060b500108eb0a5/800x.webp?source_format=png',
                        'ç™½è‰²':   'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/66e9390b87890f000d9c188e/800x.webp?source_format=png',
                        'æ²™æ¼ è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/66e9390bae72af0010d2e717/800x.webp?source_format=png'
                    }
                },
                sizes: {
                    'M (US4-8.5)': ['ç™½è‰²', 'çŠç‘šç²‰', 'é…ªæ¢¨ç¶ ', 'æ·±è—'],
                    'L (US9-12)': ['æ·±è—è‰²', 'é»‘è‰²', 'ç™½è‰²', 'æ²™æ¼ è‰²']
                }
            },
            'èˆŠæ¬¾-èµ¤è¶³æ„Ÿæ©Ÿèƒ½é•·è¥ª': { 
                price: 299, type: 'sock',
                colorImages: {
                    'M (US4-8.5)': {
                        'è—è‰²':   'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/63377a89d990c6001fc14126/800x.webp?source_format=png',
                        'ç²‰ç´…è‰²': 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/63377a89e3e15c22692e0c6d/800x.webp?source_format=png',
                        'ç´«è‰²':   'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/63377a89e95457001c5e2851/800x.webp?source_format=png'
                    }
                },
                sizes: {
                    'M (US4-8.5)': ['è—è‰²', 'ç²‰ç´…è‰²', 'ç´«è‰²']
                }
            },
            'ç¢§å®¹å¥':        { price: 1990, type: 'supplement', image: 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/68c0a87e34a1ce0016db177b/800x.webp?source_format=png' },
            'NADH':          { price: 1990, type: 'supplement', image: 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/677459ca0ed897000a513b04/800x.webp?source_format=png' },
            'æ½¤æ™¶èƒ(è‘‰é»ƒç´ )': { price: 1350, type: 'supplement', image: 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/68cc671c5099840018fd1eb7/800x.webp?source_format=png' },
            'å›ºæœ¬èƒ(æµ·è—»éˆ£)': { price: 1150, type: 'supplement', image: 'https://shoplineimg.com/5cfaac1c5fa5d4000148599a/69444c376e89dce1db622e78/800x.webp?source_format=png' }
        };

        // ========== åº«å­˜éµåå·¥å…·ï¼ˆè¥ªå­ç´°åˆ†åˆ°å°ºå¯¸+é¡è‰²ï¼‰ ==========
        function getInventoryKey(name, size, color) {
            if (products[name] && products[name].type === 'sock' && size && color) {
                return name + '|' + size + '|' + color;
            }
            return name;
        }
        function getAllInventoryKeys() {
            var keys = [];
            Object.keys(products).forEach(function(name) {
                var p = products[name];
                if (p.type === 'sock' && p.sizes) {
                    Object.keys(p.sizes).forEach(function(size) {
                        p.sizes[size].forEach(function(color) {
                            keys.push({ key: name+'|'+size+'|'+color, name: name, size: size, color: color, type: 'sock' });
                        });
                    });
                } else {
                    keys.push({ key: name, name: name, size: '', color: '', type: 'supplement' });
                }
            });
            return keys;
        }

        // ========== å…¨å±€ç‹€æ…‹ ==========
        let scriptUrl = localStorage.getItem('scriptUrl') || '';
        let orders = JSON.parse(localStorage.getItem('orders') || '[]');

        // æ¸…ç†èˆŠè¨‚å–®æ•¸æ“šï¼šç¢ºä¿ total/subtotal æ˜¯æ•¸å­—ï¼Œproducts å­˜åœ¨
        (function fixOldOrders() {
            var changed = false;
            orders.forEach(function(o) {
                if (typeof o.total !== 'number' || isNaN(o.total)) {
                    o.total = Number(o.total) || 0;
                    changed = true;
                }
                if (typeof o.subtotal !== 'number' || isNaN(o.subtotal)) {
                    o.subtotal = Number(o.subtotal) || 0;
                    changed = true;
                }
                if (typeof o.discount !== 'number' || isNaN(o.discount)) {
                    o.discount = Number(o.discount) || 0;
                    changed = true;
                }
                if (!o.products || !Array.isArray(o.products)) {
                    o.products = [];
                    changed = true;
                }
                o.products.forEach(function(p) {
                    if (typeof p.price !== 'number') p.price = Number(p.price) || 0;
                    if (typeof p.quantity !== 'number') p.quantity = Number(p.quantity) || 1;
                });
            });
            if (changed) localStorage.setItem('orders', JSON.stringify(orders));
        })();
        let currentProducts = [];
        let newOrderId = null;
        let orderCounter = parseInt(localStorage.getItem('orderCounter') || '1');
        let inventory = JSON.parse(localStorage.getItem('inventory') || '{}');

        // è¨ˆç®—ç·©å­˜ï¼ˆcalculateTotal æ¯æ¬¡ç®—å®Œæœƒæ›´æ–°ï¼Œsubmit æ™‚ç›´æ¥ç”¨ï¼‰
        var _cachedSubtotal = 0;
        var _cachedComboDiscount = 0;
        var _cachedLotteryDiscount = 0;
        var _cachedTotal = 0;

        // åˆå§‹åŒ–åº«å­˜ï¼ˆç´°åˆ†åˆ°å°ºå¯¸é¡è‰²ï¼‰
        getAllInventoryKeys().forEach(function(item) {
            if (inventory[item.key] === undefined) {
                inventory[item.key] = 50;
            }
        });

        // ========== DOMContentLoaded ==========
        document.addEventListener('DOMContentLoaded', function() {
            addProduct();
            updateAdminPanel();
            initInventoryConfig();
            updateInventoryTable();
            updateSyncStatus();
            
            document.getElementById('phoneInput').addEventListener('input', function(e) {
                const error = document.getElementById('phoneError');
                if (e.target.value.length < 8 && e.target.value.length > 0) {
                    error.style.display = 'block';
                    e.target.style.borderColor = '#dc3545';
                } else {
                    error.style.display = 'none';
                    e.target.style.borderColor = '#e9ecef';
                }
            });
            
            document.getElementById('emailInput').addEventListener('input', function(e) {
                const error = document.getElementById('emailError');
                if (!e.target.value.includes('@') && e.target.value.length > 0) {
                    error.style.display = 'block';
                    e.target.style.borderColor = '#dc3545';
                } else {
                    error.style.display = 'none';
                    e.target.style.borderColor = '#e9ecef';
                }
            });

            if (scriptUrl) {
                document.getElementById('scriptUrlInput').value = scriptUrl;
            }
        });

        // ========== Google Sheets åŒæ­¥ ==========
        function updateSyncStatus() {
            const status = document.getElementById('syncStatus');
            if (scriptUrl) {
                status.textContent = 'âœ… å·²é€£æ¥ Google Sheets';
                status.style.background = 'rgba(40,167,69,0.2)';
            } else {
                status.textContent = 'âš ï¸ å°šæœªè¨­å®š Google Sheets';
                status.style.background = 'rgba(255,193,7,0.2)';
            }
        }

        function saveScriptUrl() {
            const url = document.getElementById('scriptUrlInput').value.trim();
            if (url && url.includes('script.google.com')) {
                scriptUrl = url;
                localStorage.setItem('scriptUrl', scriptUrl);
                updateSyncStatus();
                alert('âœ… Google Sheets URL å·²å„²å­˜ï¼');
            } else {
                alert('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ Google Apps Script URL');
            }
        }

        function testGoogleSheets() {
            const resultDiv = document.getElementById('testResult');
            if (!scriptUrl) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.innerHTML = 'âŒ è«‹å…ˆè¨­å®š Google Sheets URL';
                return;
            }
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#cce5ff';
            resultDiv.style.color = '#004085';
            resultDiv.innerHTML = 'ğŸ”„ æ¸¬è©¦ä¸­...<br><small style="color:#6c757d;">ç•¶å‰ URLï¼š' + scriptUrl.substring(0, 80) + '...</small>';

            var params = new URLSearchParams();
            params.append('id', 'TEST-' + Date.now());
            params.append('date', new Date().toLocaleDateString('zh-TW'));
            params.append('time', new Date().toLocaleTimeString('zh-TW', { hour12: false }));
            params.append('name', 'æ¸¬è©¦å®¢æˆ¶');
            params.append('phone', '0912345678');
            params.append('email', 'test@test.com');
            params.append('product1', 'è¿…é¦³äº”è¶¾æ©Ÿèƒ½è¥ª');
            params.append('size1', 'M (US4-8.5)');
            params.append('color1', 'å¥¶èŒ¶è‰²');
            params.append('quantity1', '1');
            params.append('price1', '490');
            params.append('lottery', '');
            params.append('subtotal', '490');
            params.append('discount', '0');
            params.append('discountDetails', 'æ¸¬è©¦è¨‚å–®');
            params.append('extraDiscount', '0');
            params.append('total', '490');
            params.append('payment', 'æ¸¬è©¦');
            params.append('bank', '');
            params.append('note', 'ç³»çµ±æ¸¬è©¦è¨‚å–®');

            var fullUrl = scriptUrl + '?' + params.toString();
            console.log('[æ¸¬è©¦] å®Œæ•´ URLï¼š', fullUrl);

            fetch(fullUrl, { mode: 'no-cors' })
                .then(function(response) {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.color = '#155724';
                    resultDiv.innerHTML = 'âœ… è«‹æ±‚é€å‡ºå®Œæˆï¼ˆtype: ' + response.type + 'ï¼‰<br>' +
                        '<hr style="margin:10px 0;">' +
                        '<strong style="color:#856404;">âš ï¸ å¦‚æœ Sheet æ²’æœ‰è³‡æ–™ï¼Œè«‹å°‡ä¸‹æ–¹ URL è²¼é€²ç€è§ˆå™¨ç¶²å€åˆ—ä¾†çœ‹çœ‹ Apps Script çš„éŒ¯èª¤è¨Šæ¯ï¼š</strong><br><br>' +
                        '<textarea id="debugUrl" style="width:100%;height:80px;font-size:11px;border:1px solid #ccc;border-radius:4px;padding:6px;resize:none;font-family:monospace;" readonly>' + fullUrl + '</textarea><br><br>' +
                        '<button onclick="document.getElementById(\'debugUrl\').select();document.execCommand(\'copy\');this.textContent=\'âœ… å·²è¤‡è£½\';" style="padding:6px 14px;background:#667eea;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;">ğŸ“‹ è¤‡è£½ URL</button>';
                })
                .catch(function(err) {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.color = '#721c24';
                    resultDiv.innerHTML = 'âŒ é€å‡ºå¤±æ•—ï¼š' + err.message + '<br><small style="color:#6c757d;">URLï¼š' + scriptUrl.substring(0, 80) + '...</small>';
                });
        }

        // ========== Tab åˆ‡æ› ==========
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            if (tab === 'order') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('order-tab').style.display = 'block';
            } else if (tab === 'admin') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('admin-tab').style.display = 'block';
                updateAdminPanel();
            } else if (tab === 'inventory') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('inventory-tab').style.display = 'block';
                initInventoryConfig();
                updateInventoryTable();
            }
        }

        // ========== åº«å­˜è¨­å®šï¼ˆç´°åˆ†ç‰ˆï¼‰ ==========
        function initInventoryConfig() {
            var container = document.getElementById('inventoryConfigList');
            var allKeys = getAllInventoryKeys();
            var grouped = {};
            allKeys.forEach(function(item) {
                if (!grouped[item.name]) grouped[item.name] = [];
                grouped[item.name].push(item);
            });

            var html = '';
            Object.keys(grouped).forEach(function(name) {
                var p = products[name];
                html += '<div style="margin-bottom:20px;">' +
                    '<div style="font-weight:bold;font-size:14px;color:#667eea;padding:6px 0;border-bottom:1px solid #dee2e6;margin-bottom:10px;">' + name + ' ($' + p.price + ')</div>';

                if (p.type === 'sock') {
                    var bySizes = {};
                    grouped[name].forEach(function(item) {
                        if (!bySizes[item.size]) bySizes[item.size] = [];
                        bySizes[item.size].push(item);
                    });
                    Object.keys(bySizes).forEach(function(size) {
                        html += '<div style="font-size:12px;color:#495057;margin:8px 0 5px;font-weight:600;">' + size + '</div>';
                        html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:6px;">';
                        bySizes[size].forEach(function(item) {
                            var safeId = 'inv_' + item.key.replace(/[|() ]/g, '_');
                            html += '<div style="display:flex;align-items:center;gap:8px;background:#f8f9fa;padding:5px 8px;border-radius:6px;">' +
                                '<label style="font-size:12px;flex:1;">' + item.color + '</label>' +
                                '<input type="number" id="' + safeId + '" value="' + (inventory[item.key] || 50) + '" min="0" style="width:55px;padding:4px;border:1px solid #dee2e6;border-radius:4px;text-align:center;">' +
                            '</div>';
                        });
                        html += '</div>';
                    });
                } else {
                    var item = grouped[name][0];
                    var safeId = 'inv_' + item.key.replace(/[|() ]/g, '_');
                    html += '<div style="display:flex;align-items:center;gap:8px;">' +
                        '<input type="number" id="' + safeId + '" value="' + (inventory[item.key] || 50) + '" min="0" style="width:80px;padding:6px;border:1px solid #dee2e6;border-radius:4px;text-align:center;">' +
                    '</div>';
                }
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function saveInventoryConfig() {
            getAllInventoryKeys().forEach(function(item) {
                var safeId = 'inv_' + item.key.replace(/[|() ]/g, '_');
                var input = document.getElementById(safeId);
                if (input) inventory[item.key] = parseInt(input.value) || 0;
            });
            localStorage.setItem('inventory', JSON.stringify(inventory));
            alert('âœ… åº«å­˜è¨­å®šå·²å„²å­˜ï¼');
            updateInventoryTable();
            updateAdminPanel();
        }

        // åº«å­˜è¡¨æ ¼ï¼ˆç´°åˆ†ç‰ˆï¼‰
        function updateInventoryTable() {
            var sold = {};
            orders.forEach(function(order) {
                order.products.forEach(function(product) {
                    var key = getInventoryKey(product.name, product.size, product.color);
                    sold[key] = (sold[key] || 0) + product.quantity;
                });
            });

            var allKeys = getAllInventoryKeys();
            var grouped = {};
            allKeys.forEach(function(item) {
                if (!grouped[item.name]) grouped[item.name] = [];
                grouped[item.name].push(item);
            });

            var tbody = document.getElementById('inventoryTableBody');
            var html = '';
            Object.keys(grouped).forEach(function(name) {
                html += '<tr style="background:#eef2ff;"><td colspan="5" style="font-weight:bold;color:#667eea;padding:8px 12px;">' + name + '</td></tr>';
                grouped[name].forEach(function(item) {
                    var soldQty = sold[item.key] || 0;
                    var initial = inventory[item.key] || 0;
                    var remaining = initial - soldQty;
                    var status = 'âœ“ æ­£å¸¸', statusColor = '#28a745';
                    if (remaining <= 0)  { status = 'âŒ å·²å”®ç½„'; statusColor = '#dc3545'; }
                    else if (remaining <= 5) { status = 'âš ï¸ åº«å­˜ä¸è¶³'; statusColor = '#ffc107'; }

                    var label = item.type === 'sock' ? item.size + ' / ' + item.color : 'â€”';
                    html += '<tr>' +
                        '<td style="padding:6px 12px;font-size:13px;color:#495057;">' + label + '</td>' +
                        '<td style="text-align:center;">' + initial + '</td>' +
                        '<td style="text-align:center;">' + soldQty + '</td>' +
                        '<td style="text-align:center;font-weight:bold;">' + remaining + '</td>' +
                        '<td style="color:' + statusColor + ';font-weight:bold;">' + status + '</td>' +
                    '</tr>';
                });
            });
            tbody.innerHTML = html;
        }

        // ========== æ—¥æœŸé¸æ“‡ ==========
        function selectDate(date) {
            document.querySelectorAll('.date-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.date-option').classList.add('selected');
            document.getElementById('selectedDate').value = date;
            document.getElementById('dateError').style.display = 'none';
            calculateTotal();
        }

        // ========== å•†å“é¸æ“‡ ==========
        function addProduct() {
            const productList = document.getElementById('productList');
            const index = currentProducts.length;
            
            const productHtml = `
                <div class="product-item" data-index="${index}" style="grid-template-columns: 80px 1fr 120px auto; background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e9ecef;">
                    <div id="imgbox-${index}" style="display:none;">
                        <img id="productImg-${index}" src="" alt="" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #e9ecef;background:#f8f9fa;">
                    </div>
                    <div id="imgbox-placeholder-${index}" style="width:80px;height:80px;background:#f0f0f0;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:24px;">ğŸ§¦</div>
                    <div>
                        <select onchange="updateProduct(${index})" required style="width: 100%; margin-bottom: 8px;">
                            <option value="">é¸æ“‡å•†å“</option>
                            ${Object.keys(products).map(name => {
                                return '<option value="' + name + '">' + name + ' - $' + products[name].price + '</option>';
                            }).join('')}
                        </select>
                        <div id="options-${index}" style="display: none;">
                            <select id="size-${index}" onchange="updateSize(${index})" style="width: 100%; margin-bottom: 5px; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;">
                                <option value="">é¸æ“‡å°ºå¯¸</option>
                            </select>
                            <select id="color-${index}" onchange="updateColor(${index})" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;">
                                <option value="">é¸æ“‡é¡è‰²</option>
                            </select>
                        </div>
                    </div>
                    <div class="quantity-selector">
                        <button type="button" class="quantity-btn" onclick="decreaseQuantity(${index})">âˆ’</button>
                        <div class="quantity-display" id="qty-${index}">1</div>
                        <button type="button" class="quantity-btn" onclick="increaseQuantity(${index})">+</button>
                    </div>
                    <button type="button" class="remove-btn" onclick="removeProduct(${index})">åˆªé™¤</button>
                </div>
            `;
            
            productList.insertAdjacentHTML('beforeend', productHtml);
            currentProducts.push({ name: '', quantity: 1, price: 0, size: '', color: '' });
        }

        function increaseQuantity(index) {
            if (currentProducts[index].quantity < 99) {
                currentProducts[index].quantity++;
                document.getElementById('qty-' + index).textContent = currentProducts[index].quantity;
                calculateTotal();
            }
        }

        function decreaseQuantity(index) {
            if (currentProducts[index].quantity > 1) {
                currentProducts[index].quantity--;
                document.getElementById('qty-' + index).textContent = currentProducts[index].quantity;
                calculateTotal();
            }
        }

        function updateProduct(index) {
            const select = document.querySelectorAll('.product-item')[index].querySelector('select');
            const productName = select.value;
            const productData = products[productName];
            
            currentProducts[index].name = productName;
            currentProducts[index].price = productData ? productData.price : 0;
            currentProducts[index].size = '';
            currentProducts[index].color = '';
            
            const optionsDiv = document.getElementById('options-' + index);
            const sizeSelect = document.getElementById('size-' + index);
            const colorSelect = document.getElementById('color-' + index);
            
            // åœ–ç‰‡é¡¯ç¤º
            var imgBox = document.getElementById('imgbox-' + index);
            var productImg = document.getElementById('productImg-' + index);
            var placeholder = document.getElementById('imgbox-placeholder-' + index);
            if (productData && productData.type === 'supplement' && productData.image) {
                imgBox.style.display = 'block';
                placeholder.style.display = 'none';
                productImg.src = productData.image;
            } else {
                imgBox.style.display = 'none';
                placeholder.style.display = 'flex';
                placeholder.textContent = productData && productData.type === 'sock' ? 'ğŸ§¦' : 'ğŸ›ï¸';
            }

            if (productData && productData.type === 'sock') {
                optionsDiv.style.display = 'block';
                sizeSelect.innerHTML = '<option value="">é¸æ“‡å°ºå¯¸</option>' +
                    Object.keys(productData.sizes).map(function(size) {
                        return '<option value="' + size + '">' + size + '</option>';
                    }).join('');
                colorSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å°ºå¯¸</option>';
                colorSelect.disabled = true;
            } else {
                optionsDiv.style.display = 'none';
            }
            
            calculateTotal();
        }

        function updateSize(index) {
            const productName = currentProducts[index].name;
            const productData = products[productName];
            const sizeSelect = document.getElementById('size-' + index);
            const colorSelect = document.getElementById('color-' + index);
            const selectedSize = sizeSelect.value;
            
            currentProducts[index].size = selectedSize;
            currentProducts[index].color = '';
            
            if (selectedSize && productData && productData.sizes[selectedSize]) {
                colorSelect.disabled = false;
                colorSelect.innerHTML = '<option value="">é¸æ“‡é¡è‰²</option>' +
                    productData.sizes[selectedSize].map(function(color) {
                        return '<option value="' + color + '">' + color + '</option>';
                    }).join('');
                // é‡æ–°ç¶å®š onchangeï¼ˆéƒ¨åˆ†ç€è¦½å™¨å‹•æ…‹ä¿®æ”¹ innerHTML å¾Œäº‹ä»¶æœƒå¤±éˆï¼‰
                colorSelect.onchange = function() { updateColor(index); };
            } else {
                colorSelect.disabled = true;
                colorSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å°ºå¯¸</option>';
            }
            // åˆ‡æ›å°ºå¯¸æ™‚éš±è—åœ–ç‰‡ï¼Œå›åˆ°ä½”ä½åœ–
            var imgBox2 = document.getElementById('imgbox-' + index);
            var placeholder2 = document.getElementById('imgbox-placeholder-' + index);
            if (imgBox2) imgBox2.style.display = 'none';
            if (placeholder2) placeholder2.style.display = 'flex';

            calculateTotal();
        }

        function updateColor(index) {
            const colorSelect = document.getElementById('color-' + index);
            currentProducts[index].color = colorSelect.value;

            // é¸å®Œé¡è‰²å¾Œé¡¯ç¤ºå°æ‡‰åœ–ç‰‡
            var name = currentProducts[index].name;
            var size = currentProducts[index].size;
            var color = colorSelect.value;
            var pd = products[name];
            var imgBox = document.getElementById('imgbox-' + index);
            var productImg = document.getElementById('productImg-' + index);
            var placeholder = document.getElementById('imgbox-placeholder-' + index);
            if (pd && pd.colorImages && pd.colorImages[size] && pd.colorImages[size][color]) {
                imgBox.style.display = 'block';
                placeholder.style.display = 'none';
                productImg.src = pd.colorImages[size][color];
            } else {
                imgBox.style.display = 'none';
                placeholder.style.display = 'flex';
            }

            calculateTotal();
        }

        function removeProduct(index) {
            document.querySelector('[data-index="' + index + '"]').remove();
            currentProducts.splice(index, 1);
            calculateTotal();
        }

        // ========== è¨ˆç®—ç¸½é‡‘é¡ ==========
        function calculateTotal() {
            let subtotal = 0;
            let sockCount = 0;
            let suppCount = 0;
            let hasOldSock = false;

            currentProducts.forEach(item => {
                if (item.name && item.quantity > 0) {
                    subtotal += item.price * item.quantity;
                    const productData = products[item.name];
                    if (productData && productData.type === 'sock') {
                        sockCount += item.quantity;
                        if (item.name === 'èˆŠæ¬¾-èµ¤è¶³æ„Ÿæ©Ÿèƒ½é•·è¥ª') hasOldSock = true;
                    } else if (productData && productData.type === 'supplement') {
                        suppCount += item.quantity;
                    }
                }
            });

            let comboDiscount = 0;
            let comboName = '';
            if (sockCount >= 3 && suppCount >= 2) { comboDiscount = -400; comboName = 'æ‡‰æ´çµ„'; }
            else if (sockCount >= 2 && suppCount >= 1) { comboDiscount = -200; comboName = 'äººæ°£çµ„'; }
            if (hasOldSock && (sockCount + suppCount - 1) > 0) {
                comboDiscount -= 100;
                comboName += (comboName ? ' + èˆŠæ¬¾å‡ºæ¸…' : 'èˆŠæ¬¾å‡ºæ¸…');
            }

            displayDiscountInfo(sockCount, suppCount, comboName, comboDiscount);
            displaySplitSuggestion(sockCount, suppCount, comboDiscount);

            // æŠ½çæŠ˜æ‰£ï¼ˆå…ˆè¨ˆç®—ï¼Œå¾Œé¢æœƒè¢«é™åˆ¶æ¸…é›¶ï¼‰
            let lotteryDiscount = 0;
            document.querySelectorAll('input[name="lottery"]:checked').forEach(checkbox => {
                const value = checkbox.value;
                if (value === 'æŠ˜20' || value === 'æ­è£œçµ¦æŠ˜20') lotteryDiscount -= 20;
                else if (value === 'æŠ˜30') lotteryDiscount -= 30;
                else if (value === 'æŠ˜50') lotteryDiscount -= 50;
                // å®˜ç¶²9æŠ˜åˆ¸ï¼šæ˜¯å®˜ç¶²æ¶ˆè²»ç”¨çš„åˆ¸ï¼Œç¾å ´ä¸æ‰£é‡‘é¡
            });

            // é¡å¤–æŠ˜æ‰£
            const extraDiscount = parseInt(document.getElementById('extraDiscount').value || 0);
            const extraDiscountRow = document.getElementById('extraDiscountRow');
            const extraDiscountDisplay = document.getElementById('extraDiscountDisplay');
            if (extraDiscount > 0) {
                extraDiscountRow.style.display = 'flex';
                extraDiscountDisplay.textContent = '-$' + extraDiscount.toLocaleString();
            } else {
                extraDiscountRow.style.display = 'none';
            }

            document.getElementById('subtotal').textContent = '$' + subtotal.toLocaleString();
            document.getElementById('comboDiscount').textContent = comboDiscount < 0 ? '-$' + Math.abs(comboDiscount).toLocaleString() : '$0';

            // ===== æŠ½çé™åˆ¶ï¼šå•†å“å°è¨ˆéœ€æ»¿ $900 =====
            var lotteryHint = document.getElementById('lotteryHint');
            var lotteryCheckboxes = document.querySelectorAll('input[name="lottery"]');
            if (subtotal < 900) {
                lotteryCheckboxes.forEach(function(cb) {
                    if (cb.checked) {
                        cb.checked = false;
                        cb.closest('.checkbox-item').classList.remove('checked');
                    }
                    cb.disabled = true;
                    cb.closest('.checkbox-item').style.opacity = '0.4';
                    cb.closest('.checkbox-item').style.cursor = 'not-allowed';
                });
                lotteryHint.style.display = 'block';
                lotteryHint.innerHTML = 'âš ï¸ ç¾å ´æŠ½çéœ€å•†å“å°è¨ˆæ»¿ $900 æ‰å¯åƒèˆ‡ï¼ˆç›®å‰ $' + subtotal.toLocaleString() + 'ï¼Œé‚„å·® $' + (900 - subtotal).toLocaleString() + 'ï¼‰';
                lotteryDiscount = 0;
            } else {
                lotteryCheckboxes.forEach(function(cb) {
                    cb.disabled = false;
                    cb.closest('.checkbox-item').style.opacity = '1';
                    cb.closest('.checkbox-item').style.cursor = 'pointer';
                });
                // æ­è£œçµ¦æŠ˜20ï¼šé¡å¤–è¦æ±‚è¨‚å–®è£¡å¿…é ˆåŒ…å«è£œçµ¦å“
                lotteryCheckboxes.forEach(function(cb) {
                    if (cb.value === 'æ­è£œçµ¦æŠ˜20') {
                        if (suppCount < 1) {
                            if (cb.checked) {
                                cb.checked = false;
                                cb.closest('.checkbox-item').classList.remove('checked');
                            }
                            cb.disabled = true;
                            cb.closest('.checkbox-item').style.opacity = '0.4';
                            cb.closest('.checkbox-item').style.cursor = 'not-allowed';
                        }
                    }
                });
                lotteryHint.style.display = 'none';
                // å¦‚æœæ­è£œçµ¦æŠ˜20 è¢«ç¦ç”¨ï¼Œçµ¦æç¤º
                var suppCb = document.querySelector('input[name="lottery"][value="æ­è£œçµ¦æŠ˜20"]');
                if (suppCb && suppCb.disabled) {
                    lotteryHint.style.display = 'block';
                    lotteryHint.innerHTML = 'ğŸ’¡ ã€Œæ­è£œçµ¦æŠ˜ $20ã€éœ€è¦è¨‚å–®è£¡åŒ…å«è£œçµ¦å“ï¼ˆç¢§å®¹å¥ã€NADHã€æ½¤æ™¶èƒã€å›ºæœ¬èƒï¼‰æ‰å¯ä½¿ç”¨';
                }
            }

            document.getElementById('lotteryDiscount').textContent = lotteryDiscount < 0 ? '-$' + Math.abs(lotteryDiscount).toLocaleString() : '$0';
            
            const total = subtotal + comboDiscount + lotteryDiscount - extraDiscount;
            document.getElementById('totalAmount').textContent = '$' + Math.max(0, total).toLocaleString();

            // ç·©å­˜åˆ°å…¨å±€è®Šæ•¸ï¼Œæäº¤è¨‚å–®æ™‚ç›´æ¥å¾é€™è£¡æ‹¿ï¼ˆé¿å…å¾ DOM textContent è®€å›ä¾†é‡åˆ° toLocaleString æ ¼å¼å•é¡Œï¼‰
            _cachedSubtotal = subtotal;
            _cachedComboDiscount = comboDiscount;
            _cachedLotteryDiscount = lotteryDiscount;
            _cachedTotal = Math.max(0, total);
        }

        function displayDiscountInfo(sockCount, suppCount, comboName, comboDiscount) {
            const container = document.getElementById('discountInfo');
            if (comboName) {
                container.innerHTML =
                    '<div class="discount-info">' +
                        '<h4>âœ¨ æ‚¨äº«æœ‰çš„å„ªæƒ </h4>' +
                        '<div class="discount-item">' +
                            '<span>' + comboName + '</span>' +
                            '<span style="color: #d63384; font-weight: bold;">-$' + Math.abs(comboDiscount) + '</span>' +
                        '</div>' +
                    '</div>';
            } else {
                container.innerHTML = '';
            }
        }

        function displaySplitSuggestion(sockCount, suppCount, currentDiscount) {
            const container = document.getElementById('splitSuggestion');
            if (sockCount >= 4 && suppCount >= 2) {
                const splitCount = Math.floor(Math.min(sockCount / 2, suppCount));
                const splitDiscount = splitCount * -200;
                const savings = Math.abs(splitDiscount) - Math.abs(currentDiscount);
                if (savings > 0) {
                    container.innerHTML =
                        '<div class="split-suggestion">' +
                            '<h4>ğŸ’¡ æ™ºæ…§æ‹†å–®å»ºè­°</h4>' +
                            '<p style="margin: 10px 0; line-height: 1.6;">' +
                                'å»ºè­°æ‹†æˆ <strong>' + splitCount + 'ç­†è¨‚å–®</strong>ï¼ˆæ¯ç­†2é›™è¥ª+1ç½ä¿å¥å“ï¼‰<br>' +
                                'å¯é¡å¤–çœä¸‹ï¼š<span style="color: #d63384; font-size: 18px; font-weight: bold;">$' + savings + '</span>' +
                            '</p>' +
                        '</div>';
                } else { container.innerHTML = ''; }
            } else { container.innerHTML = ''; }
        }

        // ========== æ”¯ä»˜æ–¹å¼ ==========
        function selectPayment(method) {
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.payment-option').classList.add('selected');
            document.getElementById('paymentMethod').value = method;
            document.getElementById('paymentError').style.display = 'none';
            if (method === 'è½‰å¸³') {
                document.getElementById('bankOptions').style.display = 'block';
            } else {
                document.getElementById('bankOptions').style.display = 'none';
                document.getElementById('bankName').value = '';
            }
        }

        function selectBank(bank) {
            document.querySelectorAll('.bank-option').forEach(opt => opt.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('bankName').value = bank;
        }

        function updateCheckboxStyle(checkbox) {
            const label = checkbox.closest('.checkbox-item');
            if (checkbox.checked) label.classList.add('checked');
            else label.classList.remove('checked');
            calculateTotal();
        }

        // ========== é€å‡ºåˆ° Google Sheets ==========
        function sendToGoogleSheets(order) {
            if (!scriptUrl) { console.log('æœªè¨­å®š Google Sheets URL'); return Promise.resolve(true); }

            var params = new URLSearchParams();
            params.append('id', order.id);
            params.append('date', order.date);
            params.append('time', order.time);
            params.append('name', order.name);
            params.append('phone', order.phone);
            params.append('email', order.email);
            order.products.forEach(function(product, i) {
                params.append('product' + (i+1), product.name || '');
                params.append('size' + (i+1), product.size || '');
                params.append('color' + (i+1), product.color || '');
                params.append('quantity' + (i+1), product.quantity || 0);
                params.append('price' + (i+1), product.price || 0);
            });
            params.append('lottery', order.lottery.join(', '));
            params.append('subtotal', order.subtotal);
            params.append('discount', order.discount - (order.extraDiscount || 0));
            params.append('discountDetails', order.discountDetails || '');
            params.append('extraDiscount', order.extraDiscount || 0);
            params.append('total', order.total);
            params.append('payment', order.payment);
            params.append('bank', order.bank || '');
            params.append('note', order.note || '');

            var fullUrl = scriptUrl + '?' + params.toString();
            console.log('[é€å‡ºè¨‚å–®] URLï¼š', fullUrl);

            return fetch(fullUrl, { mode: 'no-cors' })
                .then(function(response) {
                    console.log('[é€å‡ºè¨‚å–®] æˆåŠŸï¼Œstatus:', response.status, 'type:', response.type);
                    return true;
                })
                .catch(function(err) {
                    console.log('[é€å‡ºè¨‚å–®] å¤±æ•—ï¼š', err.message);
                    return true; // ä¸é˜»æ“‹è¨‚å–®å®Œæˆ
                });
        }

        // ========== æäº¤è¨‚å–® ==========
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            let isValid = true;
            if (!document.getElementById('selectedDate').value) {
                document.getElementById('dateError').style.display = 'block';
                isValid = false;
            }
            if (!document.getElementById('paymentMethod').value) {
                document.getElementById('paymentError').style.display = 'block';
                isValid = false;
            }
            if (document.getElementById('phoneInput').value.length < 8) {
                document.getElementById('phoneError').style.display = 'block';
                isValid = false;
            }
            if (!document.getElementById('emailInput').value.includes('@')) {
                document.getElementById('emailError').style.display = 'block';
                isValid = false;
            }
            if (!isValid) { alert('âŒ è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ä¸¦ç¢ºèªæ ¼å¼æ­£ç¢º'); return; }

            // è¼‰å…¥å‹•ç•«
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.innerHTML = '<div class="loading-content"><div class="spinner"></div><p>æ­£åœ¨è™•ç†è¨‚å–®...</p></div>';
            document.body.appendChild(loading);

            const formData = new FormData(this);
            const now = new Date();
            const orderId = 'ORD' + now.getFullYear() + 
                           String(now.getMonth() + 1).padStart(2, '0') + 
                           String(now.getDate()).padStart(2, '0') + 
                           '-' + String(orderCounter).padStart(4, '0');
            
            const extraDiscount = parseInt(document.getElementById('extraDiscount').value || 0);

            // æ”¶é›†æŠ˜æ‰£æ˜ç´°æ–‡å­—
            var discountParts = [];
            var _sC = 0, _pC = 0, _hO = false;
            currentProducts.forEach(function(it) {
                if (it.name && it.quantity > 0) {
                    var pd = products[it.name];
                    if (pd && pd.type === 'sock') { _sC += it.quantity; if (it.name === 'èˆŠæ¬¾-èµ¤è¶³æ„Ÿæ©Ÿèƒ½é•·è¥ª') _hO = true; }
                    else if (pd && pd.type === 'supplement') _pC += it.quantity;
                }
            });
            if (_sC >= 3 && _pC >= 2) discountParts.push('æ‡‰æ´çµ„(-$400)');
            else if (_sC >= 2 && _pC >= 1) discountParts.push('äººæ°£çµ„(-$200)');
            if (_hO && (_sC + _pC - 1) > 0) discountParts.push('èˆŠæ¬¾å‡ºæ¸…(-$100)');
            document.querySelectorAll('input[name="lottery"]:checked').forEach(function(cb) { discountParts.push(cb.value); });
            if (extraDiscount > 0) discountParts.push('é¡å¤–æŠ˜æ‰£(-$' + extraDiscount + ')');

            const order = {
                id: orderId,
                date: formData.get('date'),
                time: now.toLocaleTimeString('zh-TW', { hour12: false }),
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                products: currentProducts.filter(p => p.name),
                payment: formData.get('payment'),
                bank: formData.get('bank') || '',
                lottery: Array.from(document.querySelectorAll('input[name="lottery"]:checked')).map(cb => cb.value),
                subtotal: _cachedSubtotal,
                discount: Math.abs(_cachedComboDiscount) + Math.abs(_cachedLotteryDiscount) + extraDiscount,
                discountDetails: discountParts.join('ã€'),
                extraDiscount: extraDiscount,
                total: _cachedTotal,
                note: formData.get('note') || '',
                timestamp: now.toISOString()
            };

            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));
            orderCounter++;
            localStorage.setItem('orderCounter', orderCounter.toString());
            newOrderId = order.id;

            await sendToGoogleSheets(order);

            document.body.removeChild(loading);

            // é‡ç½®è¡¨å–®
            this.reset();
            currentProducts = [];
            document.getElementById('productList').innerHTML = '';
            document.getElementById('extraDiscount').value = '0';
            addProduct();
            document.querySelectorAll('.date-option, .payment-option, .bank-option, .checkbox-item').forEach(el => {
                el.classList.remove('selected', 'checked');
            });
            calculateTotal();
            switchTab('admin');
        });

        // ========== å¾Œå°ï¼šè¨‚å–®è©³ç´°å½ˆçª— ==========
        function closeDetailModal() {
            var m = document.getElementById('orderDetailModal');
            if (m) m.remove();
        }

        function showOrderDetail(orderId) {
            var order = orders.find(function(o){ return o.id === orderId; });
            if (!order) return;

            var productsHTML = order.products.map(function(p) {
                return '<tr style="border-bottom:1px solid #eee;">' +
                    '<td style="padding:9px 10px;">' + p.name + '</td>' +
                    '<td style="padding:9px 10px;color:#6c757d;">' + (p.size || '-') + '</td>' +
                    '<td style="padding:9px 10px;color:#6c757d;">' + (p.color || '-') + '</td>' +
                    '<td style="padding:9px 10px;text-align:center;">' + p.quantity + '</td>' +
                    '<td style="padding:9px 10px;text-align:right;font-weight:bold;">$' + (p.price * p.quantity).toLocaleString() + '</td>' +
                '</tr>';
            }).join('');

            var discountHTML = order.discountDetails
                ? '<div style="margin-top:12px;padding:10px 14px;background:#e8f4fd;border-radius:6px;font-size:13px;color:#0277bd;">ğŸ å„ªæƒ æ˜ç´°ï¼š' + order.discountDetails + '</div>'
                : '';
            var noteHTML = order.note
                ? '<div style="margin-top:14px;padding:10px 14px;background:#fff3cd;border-radius:6px;font-size:13px;color:#856404;">ğŸ“ å‚™è¨»ï¼š' + order.note + '</div>'
                : '';
            var discountRow = order.discount > 0
                ? '<div style="display:flex;justify-content:space-between;font-size:13px;color:#d63384;margin-bottom:4px;"><span>æŠ˜æ‰£</span><span>-$' + order.discount.toLocaleString() + '</span></div>'
                : '';

            // æŒ‰éˆ•ç”¨è®Šæ•¸çµ„è£ï¼Œé¿å…å¼•è™Ÿå·¢å¥—
            var btnEdit  = document.createElement('button');
            btnEdit.style.cssText = 'padding:8px 16px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;';
            btnEdit.textContent = 'ğŸ“ ç·¨è¼¯å‚™è¨»';
            btnEdit.onclick = function(){ editNote(orderId); };

            var btnDel = document.createElement('button');
            btnDel.style.cssText = 'padding:8px 16px;background:#dc3545;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;';
            btnDel.textContent = 'ğŸ—‘ï¸ åˆªé™¤';
            btnDel.onclick = function(){ deleteOrder(orderId); };

            var btnClose = document.createElement('button');
            btnClose.style.cssText = 'padding:8px 16px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer;';
            btnClose.textContent = 'é—œé–‰';
            btnClose.onclick = closeDetailModal;

            var modal = document.createElement('div');
            modal.id = 'orderDetailModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;';
            modal.innerHTML =
                '<div style="background:white;border-radius:14px;width:90%;max-width:560px;max-height:88vh;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,0.3);">' +
                '<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:18px 22px;border-radius:14px 14px 0 0;display:flex;justify-content:space-between;align-items:center;">' +
                    '<div><div style="font-weight:bold;font-size:16px;">' + order.id + '</div><div style="font-size:12px;opacity:0.85;">' + order.date + ' | ' + (order.time || '') + '</div></div>' +
                    '<span id="detailCloseX" style="cursor:pointer;font-size:24px;line-height:1;">&times;</span>' +
                '</div>' +
                '<div style="padding:22px;">' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">' +
                        '<div style="background:#f8f9fa;padding:10px 14px;border-radius:8px;"><div style="font-size:11px;color:#6c757d;">ğŸ‘¤ è³¼è²·äºº</div><div style="font-weight:bold;">' + order.name + '</div></div>' +
                        '<div style="background:#f8f9fa;padding:10px 14px;border-radius:8px;"><div style="font-size:11px;color:#6c757d;">ğŸ“± é›»è©±</div><div>' + (order.phone || '-') + '</div></div>' +
                        '<div style="background:#f8f9fa;padding:10px 14px;border-radius:8px;"><div style="font-size:11px;color:#6c757d;">ğŸ’³ æ”¯ä»˜æ–¹å¼</div><div>' + order.payment + (order.bank ? ' (' + order.bank + ')' : '') + '</div></div>' +
                        '<div style="background:#f8f9fa;padding:10px 14px;border-radius:8px;"><div style="font-size:11px;color:#6c757d;">ğŸ“§ Email</div><div style="font-size:12px;word-break:break-all;">' + (order.email || '-') + '</div></div>' +
                    '</div>' +
                    '<div style="font-weight:bold;font-size:14px;margin-bottom:8px;">ğŸ“¦ è¨‚è³¼å•†å“</div>' +
                    '<div style="overflow-x:auto;">' +
                    '<table style="width:100%;border-collapse:collapse;font-size:13px;">' +
                        '<thead><tr style="background:#667eea;color:white;">' +
                            '<th style="padding:8px 10px;text-align:left;border-radius:6px 0 0 0;">å•†å“</th>' +
                            '<th style="padding:8px 10px;text-align:left;">å°ºå¯¸</th>' +
                            '<th style="padding:8px 10px;text-align:left;">é¡è‰²</th>' +
                            '<th style="padding:8px 10px;text-align:center;">æ•¸é‡</th>' +
                            '<th style="padding:8px 10px;text-align:right;border-radius:0 6px 0 0;">å°è¨ˆ</th>' +
                        '</tr></thead>' +
                        '<tbody style="background:#f8f9fa;">' + productsHTML + '</tbody>' +
                    '</table></div>' +
                    discountHTML +
                    '<div style="margin-top:18px;padding-top:12px;border-top:2px solid #eee;">' +
                        '<div style="display:flex;justify-content:space-between;font-size:13px;color:#6c757d;margin-bottom:4px;"><span>å•†å“å°è¨ˆ</span><span>$' + order.subtotal.toLocaleString() + '</span></div>' +
                        discountRow +
                        '<div style="display:flex;justify-content:space-between;font-size:19px;font-weight:bold;color:#667eea;margin-top:10px;padding-top:10px;border-top:1px solid #eee;"><span>æ‡‰ä»˜ç¸½é¡</span><span>$' + order.total.toLocaleString() + '</span></div>' +
                    '</div>' +
                    noteHTML +
                    '<div id="detailBtnRow" style="margin-top:20px;display:flex;gap:8px;justify-content:flex-end;"></div>' +
                '</div>' +
                '</div>';
            document.body.appendChild(modal);

            // Ã— æŒ‰éˆ•äº‹ä»¶
            document.getElementById('detailCloseX').onclick = closeDetailModal;
            // ä¸‰å€‹æŒ‰éˆ•
            var btnRow = document.getElementById('detailBtnRow');
            btnRow.appendChild(btnEdit);
            btnRow.appendChild(btnDel);
            btnRow.appendChild(btnClose);
        }

        // åˆªé™¤è¨‚å–®
        function deleteOrder(orderId) {
            if (!confirm('ç¢ºèªè¦åˆªé™¤è¨‚å–® ' + orderId + 'ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
            orders = orders.filter(function(o){ return o.id !== orderId; });
            localStorage.setItem('orders', JSON.stringify(orders));
            closeDetailModal();
            updateAdminPanel();
            updateInventoryTable();

            // é€šçŸ¥ Google Sheets åˆªé™¤è©²è¨‚å–®
            if (scriptUrl) {
                var params = new URLSearchParams();
                params.append('action', 'delete');
                params.append('id', orderId);
                fetch(scriptUrl + '?' + params.toString(), { mode: 'no-cors' })
                    .then(function() { console.log('[åˆªé™¤] å·²é€šçŸ¥ Google Sheets åˆªé™¤ï¼š' + orderId); })
                    .catch(function(e) { console.log('[åˆªé™¤] é€šçŸ¥å¤±æ•—ï¼š' + e.message); });
            }

            var toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#dc3545;color:white;padding:14px 24px;border-radius:8px;font-weight:bold;z-index:10001;animation:slideIn 0.3s ease;';
            toast.textContent = 'ğŸ—‘ï¸ è¨‚å–® ' + orderId + ' å·²åˆªé™¤';
            document.body.appendChild(toast);
            setTimeout(function(){ toast.remove(); }, 2200);
        }

        // å¼·åˆ¶åˆ·æ–°åº«å­˜ï¼ˆè§¸ç™¼ Apps Script é‡å»ºåº«å­˜ç®¡ç†è¡¨ï¼Œå¸¶å‡ºç•¶å‰æœŸåˆåº«å­˜ï¼‰
        // ä½¿ç”¨ POST é¿å… GET URL é•·åº¦é™åˆ¶ï¼ˆinventory JSON å¾ˆé•·ï¼ŒGET æœƒè¶…éé™åˆ¶ï¼‰
        function resetInventorySheets() {
            if (!scriptUrl) { alert('è«‹å…ˆè¨­å®š Google Sheets URL'); return; }
            var btn = document.getElementById('resetInventoryBtn');
            btn.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';
            btn.disabled = true;
            var params = new URLSearchParams();
            params.append('action', 'resetInventory');
            params.append('inventory', JSON.stringify(inventory));
            fetch(scriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                body: params.toString(),
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            })
                .then(function() {
                    btn.textContent = 'âœ… åº«å­˜å·²åˆ·æ–°';
                    btn.disabled = false;
                    setTimeout(function(){ btn.textContent = 'ğŸ”„ åˆ·æ–° Google Sheets åº«å­˜'; }, 2500);
                })
                .catch(function(e) {
                    btn.textContent = 'âŒ å¤±æ•—';
                    btn.disabled = false;
                });
        }

        // æ¸…é™¤ Google Sheets ä¸Šæ‰€æœ‰è¨‚å–®ï¼ˆä¸€æ¬¡æ€§æ¸…ç†èˆŠæ•¸æ“šï¼‰
        function clearAllOrders() {
            if (!scriptUrl) { alert('è«‹å…ˆè¨­å®š Google Sheets URL'); return; }
            if (!confirm('âš ï¸ é€™å°‡æ°¸ä¹…åˆªé™¤ Google Sheets è£¡çš„æ‰€æœ‰è¨‚å–®å’Œ POS æ”¶éŠ€å°è¨˜éŒ„ã€‚\nåº«å­˜ç®¡ç†æœƒæ ¹æ“šæ–°æ ¼å¼é‡æ–°å»ºç«‹ã€‚\n\nç¢ºèªè¦åŸ·è¡Œï¼Ÿ')) return;
            var btn = document.getElementById('clearAllBtn');
            btn.textContent = 'ğŸ—‘ï¸ æ¸…é™¤ä¸­...';
            btn.disabled = true;
            var params = new URLSearchParams();
            params.append('action', 'clearAll');
            fetch(scriptUrl + '?' + params.toString(), { mode: 'no-cors' })
                .then(function() {
                    btn.textContent = 'âœ… å·²æ¸…é™¤å®Œæˆ';
                    btn.disabled = false;
                    setTimeout(function(){ btn.textContent = 'ğŸ—‘ï¸ æ¸…é™¤ Google Sheets æ‰€æœ‰è¨‚å–®'; }, 3000);
                })
                .catch(function(e) {
                    btn.textContent = 'âŒ å¤±æ•—';
                    btn.disabled = false;
                });
        }

        // ========== å¾Œå°ï¼šç·¨è¼¯å‚™è¨» ==========
        function editNote(orderId) {
            var order = orders.find(function(o){ return o.id === orderId; });
            if (!order) return;
            closeDetailModal(); // å…ˆé—œé–‰è©³ç´°å½ˆçª—

            var modal = document.createElement('div');
            modal.id = 'noteModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';

            var inner = document.createElement('div');
            inner.style.cssText = 'background:white;padding:30px;border-radius:15px;max-width:500px;width:90%;';

            var h3 = document.createElement('h3');
            h3.style.cssText = 'margin-bottom:15px;color:#667eea;';
            h3.textContent = 'ğŸ“ ç·¨è¼¯è¨‚å–®å‚™è¨»';

            var info = document.createElement('p');
            info.style.cssText = 'margin-bottom:10px;color:#6c757d;font-size:14px;';
            info.textContent = 'è¨‚å–®ç·¨è™Ÿï¼š' + orderId;

            var textarea = document.createElement('textarea');
            textarea.id = 'noteEditor';
            textarea.style.cssText = 'width:100%;min-height:120px;padding:12px;border:2px solid #e9ecef;border-radius:8px;font-size:14px;font-family:inherit;resize:vertical;';
            textarea.value = order.note || '';

            var hint = document.createElement('div');
            hint.style.cssText = 'margin-top:10px;font-size:12px;color:#6c757d;';
            hint.textContent = 'ğŸ’¡ æç¤ºï¼šå¯è¨˜éŒ„é€è²¨åœ°å€ã€ç‰¹æ®Šéœ€æ±‚ã€è™•ç†ç‹€æ…‹ç­‰è³‡è¨Š';

            var btnRow = document.createElement('div');
            btnRow.style.cssText = 'margin-top:20px;display:flex;gap:10px;justify-content:flex-end;';

            var btnCancel = document.createElement('button');
            btnCancel.style.cssText = 'padding:10px 20px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;';
            btnCancel.textContent = 'å–æ¶ˆ';
            btnCancel.onclick = function(){ document.getElementById('noteModal').remove(); };

            var btnSave = document.createElement('button');
            btnSave.style.cssText = 'padding:10px 20px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;';
            btnSave.textContent = 'ğŸ’¾ å„²å­˜';
            btnSave.onclick = function(){ saveNote(orderId); };

            btnRow.appendChild(btnCancel);
            btnRow.appendChild(btnSave);
            inner.appendChild(h3);
            inner.appendChild(info);
            inner.appendChild(textarea);
            inner.appendChild(hint);
            inner.appendChild(btnRow);
            modal.appendChild(inner);
            document.body.appendChild(modal);

            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }
        
        function saveNote(orderId) {
            var order = orders.find(function(o){ return o.id === orderId; });
            if (order) {
                order.note = document.getElementById('noteEditor').value;
                localStorage.setItem('orders', JSON.stringify(orders));
                var m = document.getElementById('noteModal');
                if (m) m.remove();
                updateAdminPanel();
                var toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:15px 25px;border-radius:8px;font-weight:bold;z-index:10001;animation:slideIn 0.3s ease;';
                toast.textContent = 'âœ… å‚™è¨»å·²å„²å­˜';
                document.body.appendChild(toast);
                setTimeout(function(){ toast.remove(); }, 2000);
            }
        }

        // ========== å¾Œå°é¢æ¿ ==========
        function updateAdminPanel() {
            var totalOrders = orders.length;
            var totalRevenue = orders.reduce(function(sum, o){ return sum + (Number(o.total) || 0); }, 0);
            var today = new Date().toISOString().split('T')[0];
            var todayOrders = orders.filter(function(o){ return o.date.includes(today.replace(/-/g, '/')); }).length;

            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toLocaleString();
            document.getElementById('todayOrders').textContent = todayOrders;

            // ç”¢å“éŠ·å”®çµ±è¨ˆï¼ˆæŒ‰æ¬¾å¼/å°ºå¯¸/é¡è‰²ç´°åˆ†ï¼‰
            var sold = {};
            orders.forEach(function(order) {
                order.products.forEach(function(product) {
                    var key = getInventoryKey(product.name, product.size, product.color);
                    sold[key] = (sold[key] || 0) + product.quantity;
                });
            });

            var allKeys = getAllInventoryKeys();
            var grouped = {};
            allKeys.forEach(function(item) {
                if (!grouped[item.name]) grouped[item.name] = [];
                grouped[item.name].push(item);
            });

            var productStatsBody = document.getElementById('productStatsBody');
            var statsHtml = '';
            Object.keys(grouped).forEach(function(name) {
                // å•†å“åˆ†çµ„æ¨™é¡Œè¡Œ
                statsHtml += '<tr style="background:#eef2ff;"><td colspan="5" style="font-weight:bold;color:#667eea;padding:8px 12px;">' + name + '</td></tr>';
                grouped[name].forEach(function(item) {
                    var soldQty = sold[item.key] || 0;
                    var initial = inventory[item.key] || 0;
                    var remaining = initial - soldQty;
                    var status = 'âœ“ æ­£å¸¸', statusColor = '#28a745';
                    if (remaining <= 0)  { status = 'âŒ å·²å”®ç½„'; statusColor = '#dc3545'; }
                    else if (remaining <= 5) { status = 'âš ï¸ åº«å­˜ä¸è¶³'; statusColor = '#ffc107'; }
                    else if (soldQty > 20)   { status = 'ğŸ”¥ ç†±éŠ·'; statusColor = '#ff6b6b'; }
                    var label = item.type === 'sock' ? item.size + ' / ' + item.color : 'â€”';
                    statsHtml += '<tr>' +
                        '<td style="font-size:13px;color:#495057;padding-left:24px;">' + label + '</td>' +
                        '<td><strong>' + soldQty + '</strong></td>' +
                        '<td>' + remaining + '</td>' +
                        '<td style="color:' + statusColor + ';font-weight:bold;">' + status + '</td>' +
                    '</tr>';
                });
            });
            productStatsBody.innerHTML = statsHtml;

            // è¨‚å–®åˆ—è¡¨
            var tbody = document.getElementById('ordersTableBody');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#6c757d;">å°šç„¡è¨‚å–®è³‡æ–™</td></tr>';
            } else {
                tbody.innerHTML = orders.map(function(order) {
                    try {
                        var isNew = order.id === newOrderId;
                        var shortText = '(ç„¡å•†å“è¨˜éŒ„)';
                        if (order.products && order.products.length > 0) {
                            var firstP = order.products[0];
                            shortText = (firstP.name || 'æœªçŸ¥å•†å“') + 'Ã—' + (firstP.quantity || 1);
                            if (firstP.size && firstP.color) shortText += ' (' + firstP.color + ')';
                            if (order.products.length > 1) shortText += ' +' + (order.products.length - 1) + 'é …';
                        }

                        var discountText = order.discountDetails
                            ? '<span style="font-size:10px;color:#0277bd;">' + order.discountDetails + '</span>'
                            : (Number(order.discount) > 0)
                            ? '<span style="font-size:10px;color:#6c757d;">æŠ˜æ‰£ -$' + order.discount + '</span>'
                            : '';

                        var total = Number(order.total) || 0;

                        return '<tr class="' + (isNew ? 'new-order-highlight' : '') + '">' +
                            '<td style="font-weight:bold;font-size:12px;">' + (order.id || '-') + '</td>' +
                            '<td style="font-size:12px;">' + (order.date || '-') + (order.time ? '<br><span style="font-size:10px;color:#6c757d;">' + order.time + '</span>' : '') + '</td>' +
                            '<td style="font-size:12px;">' + (order.name || '-') + '</td>' +
                            '<td style="font-size:12px;"><span style="color:#667eea;cursor:pointer;text-decoration:underline;" onclick="showOrderDetail(\x27' + order.id + '\x27)">' + shortText + '</span></td>' +
                            '<td style="font-weight:bold;">$' + total.toLocaleString() + '<br>' + discountText + '</td>' +
                            '<td style="font-size:11px;">' + (order.payment || '-') + (order.bank ? '<br>(' + order.bank + ')' : '') + '</td>' +
                            '<td style="font-size:11px;">' + (order.note || '-') + '</td>' +
                            '<td style="white-space:nowrap;">' +
                                '<button class="edit-btn" onclick="showOrderDetail(\x27' + order.id + '\x27)">è©³ç´°</button> ' +
                                '<button class="edit-btn" onclick="editNote(\x27' + order.id + '\x27)">å‚™è¨»</button> ' +
                                '<button class="edit-btn" style="background:#dc3545;" onclick="deleteOrder(\x27' + order.id + '\x27)">åˆªé™¤</button>' +
                            '</td>' +
                        '</tr>';
                    } catch(e) {
                        console.error('è¨‚å–®é¡¯ç¤ºéŒ¯èª¤:', order, e);
                        return '<tr><td colspan="8" style="color:#dc3545;font-size:12px;">è¨‚å–® ' + (order.id || '?') + ' æ•¸æ“šç•°å¸¸</td></tr>';
                    }
                }).reverse().join('');
                if (newOrderId) setTimeout(function(){ newOrderId = null; }, 3000);
            }
        }

        // ========== åŒ¯å‡º Excel ==========
        function exportToExcel() {
            var csv = 'è¨‚å–®ç·¨è™Ÿ,æ—¥æœŸ,æ™‚é–“,å§“å,é›»è©±,Email,å•†å“,å°ºå¯¸,é¡è‰²,æ•¸é‡,å°è¨ˆ,å„ªæƒ èªªæ˜,æŠ˜æ‰£é‡‘é¡,æ‡‰ä»˜ç¸½é¡,æ”¯ä»˜æ–¹å¼,éŠ€è¡Œ,å‚™è¨»\n';
            orders.forEach(function(order) {
                order.products.forEach(function(product, idx) {
                    csv += order.id + ',' + order.date + ',' + order.time + ',' + order.name + ',' + order.phone + ',' + order.email + ',';
                    csv += product.name + ',' + (product.size || '-') + ',' + (product.color || '-') + ',' + product.quantity + ',' + (product.price * product.quantity) + ',';
                    if (idx === 0) {
                        csv += '"' + (order.discountDetails || '') + '",' + (Number(order.discount)||0) + ',' + (Number(order.total)||0) + ',';
                    } else {
                        csv += ',,,';
                    }
                    csv += order.payment + ',' + (order.bank || '') + ',"' + (order.note || '') + '"\n';
                });
            });
            if (orders.length === 0) { alert('ç›®å‰æ²’æœ‰è¨‚å–®è³‡æ–™'); return; }
            var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'orders_' + new Date().toISOString().split('T')[0] + '.csv';
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            setTimeout(function(){ document.body.removeChild(link); URL.revokeObjectURL(link.href); }, 100);
        }
    </script>
</body>
</html>
